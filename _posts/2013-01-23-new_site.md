---
layout: post
title: New Jekyll site, custom plugins, and GitHub
category: blog
tag: jekyll

type: default
short: I have a new site, developed with Jekyll. In here I describe the plugins I've hacked up so far, to get everything working nicely…

search_desc: new, site, jekyll, plugin, github
---

# {{ page.title }}

Jekyll is, according to its creators, a simple, blog aware, static site generator. It's written by one of the co-founders of GitHub, Tom Preson-Werner, and is located at [http://jekyllrb.com/](http://jekyllrb.com/)

First off, Jekyll, even for someone who doesn't like Ruby too much, is amazingly awesome. Writing up extensions is a snap (even if I do need to search up some Ruby syntax occasionally), and I really like static sites.

So, let's talk about what I did to get Jekyll working nicely for me.


## Category and Tag auto generation

I like having a nice url such as ```danneh.net/music``` for my ```music``` category (that displays all my ```music``` posts, but didn't want to need to manually make all the directories and index pages myself. I had a search around, and found that there was a prebuilt example on the [Jekyll wiki pages](https://github.com/mojombo/jekyll/wiki/Plugins) that did what I was looking for. Score!

The problem with this, however, is that I need to generate the index pages *before* the Pagination object can get its hands on them. Because this plugin runs after Pagination, I needed to switch to [eJekyll](http://rfelix.com/2010/01/19/jekyll-extensions-minus-equal-pain/) instead, and modify its [category](https://github.com/rfelix/my_jekyll_extensions/blob/master/category_gen/category_gen.rb) and [tag generation](https://github.com/rfelix/my_jekyll_extensions/blob/master/tag_gen/tag_gen.rb) plugins.

So this is the default category generation extension:

{% highlight ruby linenos=inline %}
module Jekyll
  
  class CategoryIndex < Page
    # Initialize a new CategoryIndex.
    # +base+ is the String path to the <source>
    # +dir+ is the String path between <source> and the file
    #
    # Returns <CategoryIndex>
    def initialize(site, base, dir, category)
      @site = site
      @base = base
      @dir = dir
      @name = 'index.html'
      self.process(@name)
      self.read_yaml(File.join(base, '_layouts'), 'category_index.html')
      self.data['category'] = category
      category_title_prefix = site.config['category_title_prefix'] || 'Category: '
      self.data['title'] = "#{category_title_prefix}#{category}"
    end
  end
  
  class Site
    # Write each category page
    #
    # Returns nothing
    def write_category_index(dir, category)
      index = CategoryIndex.new(self, self.source, dir, category)
      index.render(self.layouts, site_payload)
      index.write(self.dest)
    end

    def write_category_indexes
      if self.layouts.key? 'category_index'
        dir = self.config['category_dir'] || 'categories'
        self.categories.keys.each do |category|
          self.write_category_index(File.join(dir, category), category)
        end
      end
    end
  end
  
  AOP.after(Site, :write) do |site_instance, result, args|
    site_instance.write_category_indexes
  end
end
{% endhighlight %}

Fairly simple, and it works alright. However, there are a few differences that I'd like to make:

* First off, I need to fix the generation for my purposes, so that it adds the pages so that Pagination can actually parse them
* I use quite a simple structure, and only need a single layout for /all/ the autogenerated list pages (categories, tags, even the main site index), so let's use that instead of ```category_index.html```
* Rather than having everything accessed through ```danneh.net/category/<category>```, I'd rather it simply put the index page in the category's directory, like ```danneh.net/<category>``` instead.
* Add/Merge the Tag index support into this extension

### Fixing generation for Pagination
By default, this plugin writes the index pages directly to the output directory. However, we are looking to instead parse them with Pagination before we write them, so that won't do. The CategoryPageGenerator plugin on the [Jekyll wiki pages](https://github.com/mojombo/jekyll/wiki/Plugins) writes the pages in such a way that they can be parsed, so let's switch this extension to do that, instead.

First off, we need to switch it to run before the ```Site.generate``` method, so let's do that:

{% highlight ruby linenos=inline linenostart=42 %}
  AOP.after(Site, :write) do |site_instance, result, args|
{% endhighlight %}

{% highlight ruby linenos=inline linenostart=42 %}
  AOP.before(Site, :generate) do |site_instance, args|
{% endhighlight %}

Fairly simple. Now, if we look at the CategoryPageGenerator plugin, that outputs new pages with ```Site.pages << newpage```. That is so the site can go and run all the generators over it.

This extension writes it directly to the output directory, so we need to make it simply output it to the ```Site.pages``` object. Let's switch that over:

{% highlight ruby linenos=inline linenostart=26 %}
    def write_category_index(dir, category)
      index = CategoryIndex.new(self, self.source, dir, category)
      index.render(self.layouts, site_payload)
      index.write(self.dest)
    end

    def write_category_indexes
      if self.layouts.key? 'autogen_index'
        dir = self.config['category_dir'] || 'categories'
        self.categories.keys.each do |category|
          self.write_category_index(File.join(dir, category), category)
        end
      end
    end
{% endhighlight %}
{% highlight ruby linenos=inline linenostart=26 %}
    def write_category_indexes
      if self.layouts.key? 'autogen_index'
        self.categories.keys.each do |category|
          self.pages << CategoryIndex.new(self, self.source, category)
        end
      end
    end
{% endhighlight %}

If you'll notice, I also changed the way we call ```CategoryIndex```. I decided to push our third goal, the separating category indexes into their folders, in this as well.

What I did up in CategoryIndex is shown here:

{% highlight ruby linenos=inline linenostart=9 %}
    def initialize(site, base, dir, category)
      @site = site
      @base = base
      @dir = dir
{% endhighlight %}

{% highlight ruby linenos=inline linenostart=9 %}
    def initialize(site, base, category)
      @site = site
      @base = base
      @dir = category
{% endhighlight %}

### Autogen
So, changing to ```autogen_index.html``` is fairly simple, we just change:
{% highlight ruby linenos=inline linenostart=15 %}
      self.read_yaml(File.join(base, '_layouts'), 'category_index.html')
{% endhighlight %}
{% highlight ruby linenos=inline linenostart=15 %}
      self.read_yaml(File.join(base, '_layouts'), 'autogen_index.html')
{% endhighlight %}

and

{% highlight ruby linenos=inline linenostart=33 %}
      if self.layouts.key? 'category_index'
{% endhighlight %}
{% highlight ruby linenos=inline linenostart=33 %}
      if self.layouts.key? 'autogen_index'
{% endhighlight %}

### Tag support
I didn't describe this step, mostly because it's essentially what I did for the base category extension without step 3.

You can find the completed code for ```page_generation.rb``` [on GitHub.](https://github.com/Danneh/danneh.github.com/blob/source/_plugins/page_generation.rb)

Now you'll notice that we don't actually put any items in these pages. That'll be handled with our pagination code, below.


## Pagination for categories and tags

By default, Jekyll only support pagination for the site index. You want your category and tag pages that don't have a thousand posts? Sorry, you're gonna need a custom plugin.

The code that I based mine on, [Keith Marran's pagination code](http://www.marran.com/tech/category-pagination-in-jekyll/), modifies the Pagination object itself. Now, in the current gem version of Jekyll, that all works fine. However, with the newest version on GitHub, that doesn't work, so I had to make my own Jekyll fork.

Jekyll's default Pagination object is [on GitHub](https://github.com/mojombo/jekyll/blob/master/lib/jekyll/generators/pagination.rb). I decided not to include it here for size reasons.

Now, Marran's code uses a custom ```CategoryPager``` object in order to handle categories, specifically. I decided to go the route of modifying the default Pager object to search for YAML ```category``` and ```tag``` attributes, instead.

If the index you use the paginator on has ```category music```, I figure the user probably wants the music posts returned. Same as if the user has ```tag jekyll```, I figure that they want the jekyll tagged posts returned.

…To be continued


You can find the completed code for ```new_pagination.rb``` [on GitHub.](https://github.com/Danneh/jekyll/blob/master/lib/jekyll/generators/pagination.rb)
